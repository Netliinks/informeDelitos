{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Delitos</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- Clustering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <!-- html2canvas
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>-->

    <!-- leaflet-image -->
    <script src="https://rawcdn.githack.com/mapbox/leaflet-image/gh-pages/leaflet-image.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>const { jsPDF } = window.jspdf;</script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            color: #333;
        }
        .container { display: flex; height: 100vh; }
        .left-panel {
            width: 65%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .right-panel {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        #map { flex: 1; min-height: 500px; border-radius: 12px; }
        .card {
            background: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .filtros-linea {
    display: flex;
    flex-wrap: wrap;  /* Permite que se acomoden en varias l√≠neas si es muy estrecho */
    gap: 20px;
    margin-bottom: 10px;
    align-items: flex-end;
}

        .filtro-item {
    display: flex;
    flex-direction: column;
}

        .filtro-item label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .filtro-item select,
        .filtro-item input[type="text"],
        .filtro-item input[type="number"] {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            background-color: #f9f9f9;
            transition: border-color 0.3s ease;
        }

        .filtro-item select:focus,
        .filtro-item input[type="text"]:focus,
        .filtro-item input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
            background-color: #fff;
        }

        .filtro-radio {
    max-width: 120px;
    flex: none;
}

/* Mes un poco m√°s angosto */
.filtro-mes {
    width: 160px;
}

/* Tipo ocupa el resto del espacio */
.filtro-tipo {
    width: 240px;
}
        button {
            background: #007bff; color: white; border: none;
            padding: 10px 15px; border-radius: 8px; cursor: pointer;
        }
        button:hover { background: #0056b3; }
        #btnExportarPDF { background: #28a745; }
        #btnExportarPDF:hover { background: #1e7e34; }
        canvas {
    width: 100%;
    height: auto;
    max-height: 400px;
    background: #fff;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* Contenedor del gr√°fico de anillo */
#chart-top5-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}



/* Canvas del gr√°fico */
#grafico_top5 {
  width: 380px !important;   /* antes era ~200px */
  height: 380px !important;
}

#grafico_top5 + .chartjs-legend li {
  font-size: 12px;
}


/* üîπ Saca el buscador fuera del mapa */
#map {
  position: relative;
}

#search-container {
  position: absolute;
  top: -50px;   /* lo subes por encima del mapa */
  right: 0;     /* lo alineas a la derecha */
  z-index: 1000;
}

/* Ajustes de estilo opcionales */
#search-container input {
  width: 250px;
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
}
    </style>
</head>
<body>
<div class="container">

    <!-- PANEL IZQUIERDO -->
    <div class="left-panel">
        <h1>Delitos</h1>

        <form id="formulario" method="post" novalidate>
            {% csrf_token %}
            <fieldset class="filtros-linea">
                <!--<legend>2. Filtros adicionales</legend>-->

                <div class="filtro-item filtro-radio">
                    <label for="id_radio_km">Radio (m):</label>
                    {{ filtro_form.radio_km }}
                </div>

                <div class="filtro-item filtro-tipo">
                    <label for="id_delito_dnpj">Tipo:</label>
                    {{ filtro_form.delito_dnpj }}
                </div>

                <div class="filtro-item filtro-mes">
                    <label for="id_mes">Mes:</label>
                    {{ filtro_form.mes }}
                </div>
                <div class="btn-group">
                    <button type="submit" name="accion" value="cargar">Cargar Mapa</button>
                </div>
                <div class="filtro-item filtro-exportar">
                    <label>&nbsp;</label>
                    <button id="btnExportarPDF" type="button">üìÑ Exportar PDF</button>
                </div>
            </fieldset>



  <input type="hidden" name="filtrados_json" id="filtrados_json">

            <input type="hidden" name="lat_centro" id="lat_centro" value="{{ lat_centro|default:'' }}">
            <input type="hidden" name="lon_centro" id="lon_centro" value="{{ lon_centro|default:'' }}">
            <input type="hidden" name="radio_usado" id="radio_usado" value="{{ radio_usado|default:'' }}">



            <div class="btn-group">
                <!--<button type="submit" name="accion" value="graficar">Graficar</button>-->
                    <button type="button" id="btnGraficar">Graficar</button>
            </div>



        </form>

        <div id="map"></div>

        {% if coordenadas %}
            {{ coordenadas|json_script:"coordenadas-json" }}
            {{ centro|json_script:"centro-json" }}

            <script>
                const coordenadas = JSON.parse(document.getElementById('coordenadas-json').textContent);
                let centro = JSON.parse(document.getElementById('centro-json').textContent);

                if (!centro || centro.length !== 2 || centro.some(c => isNaN(c))) {
                    centro = [-1.8312, -78.1834]; // Ecuador por defecto
                }

                const map = L.map('map').setView(centro, 5);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            </script>
<!-- Cargar API de Google Maps (reemplaza TU_API_KEY_AQUI) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxD5EDwb5N4cDFh9HkFfs4P2B08IfFwoU&libraries=places"></script>

<script>
    // === CUADRO DE B√öSQUEDA ===
    const searchContainer = L.control({ position: 'topleft' });
    searchContainer.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'search-box');
        div.innerHTML = '<input id="searchInput" type="text" placeholder="Buscar ubicaci√≥n..." ' +
                        'style="width:250px;padding:6px;border-radius:6px;border:1px solid #ccc;">';
        return div;
    };








    searchContainer.addTo(map);

    // Evita que el mapa capture clics sobre el input
    L.DomEvent.disableClickPropagation(document.querySelector('.search-box'));

    // Inicializa Autocomplete
    const input = document.getElementById('searchInput');
    const autocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: "ec" },
        fields: ["geometry", "name", "formatted_address"]
    });

    autocomplete.addListener("place_changed", function() {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) {
            //alert("No se encontraron coordenadas para esa b√∫squeda.");
            return;
        }

        const lat = place.geometry.location.lat();
        const lon = place.geometry.location.lng();

        const radio = parseFloat(document.getElementById('id_radio_km').value || 0);
        if (isNaN(radio) || radio <= 0 || radio > 1000) {
            alert("Por favor ingresa un radio v√°lido entre 1 y 1000 metros.");
            return;
        }

        // Limpia y dibuja nuevos elementos
        grupoFiltro.clearLayers();
        L.marker([lat, lon], { icon: iconoRojo }).addTo(grupoFiltro);
        L.circle([lat, lon], { radius: radio, color: 'blue', fillOpacity: 0.1 }).addTo(grupoFiltro);

        // Filtra los puntos dentro del radio
        const dentro = coordenadas.filter(c => map.distance([lat, lon], c) <= radio);
         if (dentro.length === 0) {
            alert("No hay puntos dentro del radio seleccionado.");

            cluster.clearLayers();
            // Tambi√©n puedes retornar aqu√≠ para evitar guardar datos vac√≠os.
            return;
        }
        cluster.clearLayers();
        dentro.forEach(c => {
            cluster.addLayer(L.marker(c, { icon: iconoVerde }).bindPopup("Dentro del radio"));
        });

        // Guarda datos ocultos
        document.getElementById('lat_centro').value = lat;
        document.getElementById('lon_centro').value = lon;
        document.getElementById('filtrados_json').value = JSON.stringify(dentro);
        document.getElementById('radio_usado').value = radio;

        // Centra el mapa
        map.setView([lat, lon], 14);
    });

    // --- DETECTOR DE COORDENADAS MANUALES ---
input.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault(); // evita que Places intente autocompletar
        detectarCoordenadas();
    }
});

function detectarCoordenadas() {
    let valor = input.value.trim();

    // Formatos v√°lidos: "-1.23,-78.53" o "-1.23 -78.53"
    const regex = /^-?\d+(\.\d+)?[\s,]+-?\d+(\.\d+)?$/;

    if (!regex.test(valor)) {
        // No son coordenadas ‚Üí Google Places seguir√° trabajando normal
        return;
    }

    let partes = valor.replace(",", " ").split(/\s+/);
    let lat = parseFloat(partes[0]);
    let lon = parseFloat(partes[1]);

    if (isNaN(lat) || isNaN(lon)) {
        alert("Coordenadas inv√°lidas.");
        return;
    }

    ejecutarBusquedaManual(lat, lon);
}

function ejecutarBusquedaManual(lat, lon) {
    const radio = parseFloat(document.getElementById('id_radio_km').value || 0);
    if (isNaN(radio) || radio <= 0 || radio > 1000) {
        alert("Por favor ingresa un radio v√°lido entre 1 y 1000 metros.");
        return;
    }

    grupoFiltro.clearLayers();
    L.marker([lat, lon], { icon: iconoRojo }).addTo(grupoFiltro);
    L.circle([lat, lon], { radius: radio, color: 'blue', fillOpacity: 0.1 }).addTo(grupoFiltro);

    const dentro = coordenadas.filter(c => map.distance([lat, lon], c) <= radio);

    cluster.clearLayers();
    dentro.forEach(c => {
        cluster.addLayer(L.marker(c, { icon: iconoVerde }).bindPopup("Dentro del radio"));
    });

    document.getElementById('lat_centro').value = lat;
    document.getElementById('lon_centro').value = lon;
    document.getElementById('filtrados_json').value = JSON.stringify(dentro);
    document.getElementById('radio_usado').value = radio;

    map.setView([lat, lon], 14);
}
</script>






<script>

                const iconoRojo = L.icon({
                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });
                const iconoVerde = L.icon({
                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });

                const grupoFiltro = L.layerGroup().addTo(map);
                const cluster = L.markerClusterGroup();

                coordenadas.forEach(coord => {
                    if (coord.length === 2) {
                        cluster.addLayer(L.marker([coord[0], coord[1]]));
                    }
                });
                map.addLayer(cluster);

                if (coordenadas.length > 0) {
                    const bounds = L.latLngBounds(coordenadas);
                    map.fitBounds(bounds);
                }

                // Click en mapa
                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lon = e.latlng.lng;
                    grupoFiltro.clearLayers();

                    L.marker([lat, lon], { icon: iconoRojo }).addTo(grupoFiltro);

                    const radio = parseFloat(document.getElementById('id_radio_km').value || 0);
                    if (isNaN(radio) || radio <= 0 || radio > 1000) {
                        alert("Por favor ingresa un radio v√°lido entre 1 y 1000 metros.");
                        return;
                    }

                    L.circle([lat, lon], { radius: radio, color: 'blue', fillOpacity: 0.1 }).addTo(grupoFiltro);

                    const dentro = coordenadas.filter(c => map.distance([lat, lon], c) <= radio);
                    cluster.clearLayers();
                    dentro.forEach(c => {
                        cluster.addLayer(L.marker(c, { icon: iconoVerde }).bindPopup("Dentro del radio"));
                    });

                    document.getElementById('lat_centro').value = lat;
                    document.getElementById('lon_centro').value = lon;
                    document.getElementById('filtrados_json').value = JSON.stringify(dentro);
                    document.getElementById('radio_usado').value = radio;
                    console.log("Guardados:", lat, lon, radio);
                });


                                // Redibujar el c√≠rculo si hay datos previos
                const lat_centro = parseFloat(document.getElementById('lat_centro').value);
                const lon_centro = parseFloat(document.getElementById('lon_centro').value);
                const radio_usado = parseFloat(document.getElementById('radio_usado').value);
                console.log("Recuperados:", lat_centro, lon_centro, radio_usado);
                if (!isNaN(lat_centro) && !isNaN(lon_centro) && !isNaN(radio_usado)) {
                    L.marker([lat_centro, lon_centro], { icon: iconoRojo }).addTo(grupoFiltro);
                    L.circle([lat_centro, lon_centro], { radius: radio_usado, color: 'blue', fillOpacity: 0.1 }).addTo(grupoFiltro);
                    const zoomLevel = map.getZoom() < 14 ? 14 : map.getZoom();  // mantiene zoom m√≠nimo de 14
                    map.setView([lat_centro, lon_centro], zoomLevel);
                }
            </script>
        {% else %}
            <script>
                map = L.map('map').setView([-1.8312, -78.1834], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            </script>
        {% endif %}
    </div>

    <!-- PANEL DERECHO -->
    <div class="right-panel">
        <h2>Delitos por franja horaria</h2>
        <canvas id="grafico2"></canvas>
        <h2>Delitos por semana del mes</h2>
        <canvas id="grafico_semanal"></canvas>



        <div id="chart-top5-container">
  <h5 class="mt-3 mb-2 text-center">Top 5 Delitos</h5>
  <canvas id="grafico_top5"></canvas>
</div>
        <!--<button id="btnExportarPDF">üìÑ Exportar gr√°fico a PDF</button>-->

        {% if franjas and conteos %}
            {{ conteos|json_script:"conteos-json" }}
            {{ franjas|json_script:"franjas-json" }}
            {{ semanas|json_script:"semanas-json" }}
            {{ conteos_semanales|json_script:"conteos_semanales-json" }}
            {{ delitos_circuito|json_script:"top5-labels-json" }}
            {{ valores_circuito|json_script:"top5-values-json" }}

            <script>



                // Gr√°fico por franjas horarias
                const ctx2 = document.getElementById('grafico2').getContext('2d');
                const labels = JSON.parse(document.getElementById('franjas-json').textContent);
                const data = JSON.parse(document.getElementById('conteos-json').textContent);
                new Chart(ctx2, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'Recuento de DELITO', data: data, backgroundColor: '#2e7d32',barThickness: 50 }] },
                    options: { responsive: true, plugins: { legend: { display: false },datalabels: {
        color: 'white',  // color de los n√∫meros dentro de las barras
        font: {
          weight: 'bold',
          size: 12
        },
        formatter: function(value) {
          return value;
        }
      } },
                    devicePixelRatio: 2.5
                    ,
                    scales: {
    x: {
      categoryPercentage: 1.8,
      barPercentage: 3.6
    }
  }
                },
                    plugins: [ChartDataLabels]
                });

                // Gr√°fico semanal
                const ctx3 = document.getElementById('grafico_semanal').getContext('2d');
                const semanas = JSON.parse(document.getElementById('semanas-json').textContent);
                const delitos_semanales = JSON.parse(document.getElementById('conteos_semanales-json').textContent);
                new Chart(ctx3, {
                    type: 'bar',
                    data: { labels: semanas, datasets: [{ label: 'Recuento de DELITO por Semana', data: delitos_semanales, backgroundColor: '#1e3a8a',
                    barPercentage: 0.5,categoryPercentage: 0.7 }] },
                    options: { responsive: true, plugins: { legend: { display: false },datalabels: {
        color: 'white',  // color de los n√∫meros dentro de las barras
        font: {
          weight: 'bold',
          size: 12
        },
        formatter: function(value) {
          return value;
        }
      } } ,
                    devicePixelRatio: 2.5
                },
                    plugins: [ChartDataLabels]
                });
                // Gr√°fico Top 5 Delitos (anillo)
// === Gr√°fico Top 5 Delitos (anillo) ===
const canvasTop5 = document.getElementById('grafico_top5');
// üîπ Establece tama√±o ANTES de crear el gr√°fico (clave)
canvasTop5.width = 300;
canvasTop5.height = 300;

const ctxTop5 = canvasTop5.getContext('2d');
const top5Labels = JSON.parse(document.getElementById('top5-labels-json').textContent);
const top5Values = JSON.parse(document.getElementById('top5-values-json').textContent);

const top5Chart = new Chart(ctxTop5, {
    type: 'doughnut',
    data: {
        labels: top5Labels,
        datasets: [{
            label: 'Top 5 Delitos',
            data: top5Values,
            backgroundColor: [
                '#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: false,            // ‚ùó Clave: desactivar para que respete tama√±o fijo
        maintainAspectRatio: false,   // ‚ùó Evita que cambie proporci√≥n seg√∫n el navegador
        devicePixelRatio: 2.5,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12,
                    padding: 15,
                    font: { size: 6 }
                },
                title: {
                    display: true,
                    text: 'Tipos de Delito',
                    font: { size: 8, weight: 'bold' }
                }
            },
            datalabels: {}
        },
        layout: { padding: 8 },
        cutout: '50%'
    },
    plugins: [ChartDataLabels]
});



                // Exportar PDF usando html2canvas (Opci√≥n 2)
document.getElementById("btnExportarPDF").addEventListener("click", () => {
    const pdf = new jsPDF("landscape", "mm", "a4");
    const canvas1 = document.getElementById("grafico2");         // Franja horaria
    const canvas2 = document.getElementById("grafico_semanal");  // Semanas
    const canvas3 = document.getElementById("grafico_top5");     // Top 5

    function getHighResImage(canvas, scale = 2) {
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width * scale;
    tempCanvas.height = canvas.height * scale;
    const ctx = tempCanvas.getContext("2d");

    // Fondo blanco para evitar fondo negro al exportar a JPEG
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

    ctx.scale(scale, scale);
    ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height);

    // Exportar como JPEG comprimido
    return tempCanvas.toDataURL("image/jpeg", 0.7);
}

    const img1 = getHighResImage(canvas1, 2);
    const img2 = getHighResImage(canvas2, 2);
    const img3 = getHighResImage(canvas3, 2);

    const membreteImg = new Image();
    membreteImg.src = "{% static 'mapa/logo1.png' %}";
    const membretePieImg = new Image();
    membretePieImg.src = "{% static 'mapa/logo2.png' %}";

    membreteImg.onload = () => {
        const delitoSeleccionado = $('#id_delito_dnpj').find('option:selected').text();
        const mesSeleccionado = $('#id_mes').val();
        const radioSeleccionado = $('#id_radio_km').val();
        let mesEnPalabras = "Todos";
        if (mesSeleccionado && mesSeleccionado !== "TODOS") {
            mesEnPalabras = formatearMes(mesSeleccionado);
        }
// üß© Asegura que los puntos filtrados est√©n actualizados antes del PDF
function actualizarFiltradosJSON() {
    const lat = parseFloat(document.getElementById('lat_centro').value);
    const lon = parseFloat(document.getElementById('lon_centro').value);
    const radio = parseFloat(document.getElementById('radio_usado').value);

    if (isNaN(lat) || isNaN(lon) || isNaN(radio)) {
        console.warn("‚ö†Ô∏è No hay datos v√°lidos para calcular los puntos dentro del radio.");
        return;
    }

    // Usa la misma l√≥gica que en el mapa
    const dentro = coordenadas.filter(c => map.distance([lat, lon], c) <= radio);
    document.getElementById('filtrados_json').value = JSON.stringify(dentro);
    console.log(`‚úÖ ${dentro.length} puntos filtrados actualizados antes del PDF.`);
}

// üîπ Actualiza los puntos antes de generar la imagen del mapa
actualizarFiltradosJSON();
        // üîπ Captura el mapa con leaflet-image

  const currentZoom = map.getZoom();
map.setZoom(currentZoom); // fuerza render actual      
leafletImage(map, function (err, canvasMap) {
    if (err) { console.error(err); return; }

    const tmpCanvas = document.createElement("canvas");
    tmpCanvas.width = canvasMap.width;
    tmpCanvas.height = canvasMap.height;
    const ctx = tmpCanvas.getContext("2d");

    // 1Ô∏è‚É£ Dibuja el mapa base
    ctx.drawImage(canvasMap, 0, 0);

    // 2Ô∏è‚É£ Dibuja el c√≠rculo azul y clusters
    const lat_centro = parseFloat(document.getElementById('lat_centro').value);
    const lon_centro = parseFloat(document.getElementById('lon_centro').value);
    const radio_usado = parseFloat(document.getElementById('radio_usado').value);

    if (!isNaN(lat_centro) && !isNaN(lon_centro) && !isNaN(radio_usado)) {
        const bounds = map.getBounds();
        const nw = bounds.getNorthWest();
        const se = bounds.getSouthEast();

        // Conversi√≥n coordenadas ‚Üí p√≠xeles
        function latLngToImagePoint(lat, lon) {
            const x = ((lon - nw.lng) / (se.lng - nw.lng)) * tmpCanvas.width;
            const y = ((nw.lat - lat) / (nw.lat - se.lat)) * tmpCanvas.height;
            return { x, y };
        }

        // Centro del c√≠rculo
        const centerPoint = latLngToImagePoint(lat_centro, lon_centro);

        // Radio en p√≠xeles
        const p1 = map.containerPointToLatLng([0, 0]);
        const p2 = map.containerPointToLatLng([0, 100]);
        const metersPerPixel = map.distance(p1, p2) / 100;
        const radioPixels = radio_usado / metersPerPixel;

        // üîµ C√≠rculo azul
        ctx.beginPath();
        ctx.arc(centerPoint.x, centerPoint.y, radioPixels, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(0,0,255,0.1)";
        ctx.fill();
        ctx.strokeStyle = "blue";
        ctx.lineWidth = 2;
        ctx.stroke();

        // === Dibuja clusters de puntos ===
        const puntosDentro = JSON.parse(document.getElementById('filtrados_json').value || '[]');
        const clusterRadius = 25;

        const puntosCanvas = puntosDentro.map(p => latLngToImagePoint(p[0], p[1]));
        const clusters = [];

        puntosCanvas.forEach(pt => {
            let cluster = clusters.find(c =>
                Math.hypot(c.x - pt.x, c.y - pt.y) < clusterRadius
            );
            if (cluster) {
                cluster.count++;
                cluster.x = (cluster.x * (cluster.count - 1) + pt.x) / cluster.count;
                cluster.y = (cluster.y * (cluster.count - 1) + pt.y) / cluster.count;
            } else {
                clusters.push({ x: pt.x, y: pt.y, count: 1 });
            }
        });

        clusters.forEach(c => {
            const r = Math.min(6 + c.count * 2, 20);
            let color = "rgba(0,150,0,0.8)";
            if (c.count > 10) color = "rgba(255,165,0,0.8)";
            if (c.count > 25) color = "rgba(255,0,0,0.8)";

            ctx.beginPath();
            ctx.arc(c.x, c.y, r, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.fillStyle = "white";
            ctx.font = "bold 10px sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(c.count, c.x, c.y);
        });

        console.log(`üìä Se agruparon ${puntosCanvas.length} puntos en ${clusters.length} clusters.`);
    }

    // 3Ô∏è‚É£ Genera la imagen FINAL despu√©s de dibujar todo
    const imgMapFinal = tmpCanvas.toDataURL("image/jpeg", 0.7);

    // 4Ô∏è‚É£ Inserta el canvas rojo de depuraci√≥n (opcional)
    //document.body.appendChild(tmpCanvas);
    //tmpCanvas.style.position = "fixed";
    //tmpCanvas.style.top = "10px";
    //tmpCanvas.style.right = "10px";
    //tmpCanvas.style.zIndex = "9999";
    //tmpCanvas.style.border = "2px solid red";

    // 5Ô∏è‚É£ Dibuja en el PDF usando la imagen generada
    const margenSuperior = 15;

    pdf.addImage(membreteImg, "PNG", 15, 8 + margenSuperior, 75, 13);
    pdf.setDrawColor(0, 200, 100);
    pdf.setLineWidth(0.5);
    pdf.roundedRect(10, 30 + margenSuperior, 125, 25, 2, 2);
    pdf.setFontSize(14);
    pdf.setFont(undefined, "bold");
    pdf.text("RESUMEN DE DELITOS MENSUALES", 25, 36 + margenSuperior);
    pdf.setFontSize(10);
    pdf.setFont(undefined, "normal");
    pdf.text(`Alcance: ${radioSeleccionado} metros.`, 15, 43 + margenSuperior);
    pdf.text(`Mes: ${mesEnPalabras}`, 15, 48 + margenSuperior);
    pdf.text(`Tipo Delito: ${delitoSeleccionado}`, 15, 53 + margenSuperior);
// Mapa (parte izquierda inferior)
            pdf.setFontSize(11);
            pdf.setFont(undefined, "bold");
            pdf.setFont(undefined, "normal");
            pdf.addImage(img1, "PNG", 10, 63 + margenSuperior, 125, 80); // Tama√±o ajustado

            // Gr√°fico 1: Semanas del mes (barra derecha arriba)
            const marco1 = { x: 140, y: 15 + margenSuperior, width: 70, height: 65 };
            pdf.setDrawColor(0, 200, 100);
            pdf.setLineWidth(0.5);
            pdf.roundedRect(marco1.x, marco1.y, marco1.width, marco1.height, 2, 2);
            pdf.setFontSize(7);
            pdf.text("Frecuencia de delitos por semana", marco1.x + marco1.width / 2, marco1.y + 7, { align: "center" });
            // T√≠tulos de ejes para marco1
            pdf.setFontSize(5);
            pdf.text("Semanas del Mes", marco1.x + marco1.width / 2, marco1.y + marco1.height - 5, { align: "center" }); // Eje X
            pdf.text("Recuento de DELITO", marco1.x + 12, marco1.y + marco1.height / 2, { angle: 90, align: "center" });   // Eje Y (rotado)

            pdf.addImage(img2, "PNG", marco1.x + 5, marco1.y + 12, marco1.width - 10, marco1.height - 25);

            // Gr√°fico 2: Franja horaria (barra izquierda arriba)
            const marco2 = { x: 212, y: 15 + margenSuperior, width: 75, height: 65 };
            pdf.roundedRect(marco2.x, marco2.y, marco2.width, marco2.height, 2, 2);
            pdf.setFontSize(7);
            pdf.text("Cantidad de delitos por franja horaria", marco2.x + marco2.width / 2, marco2.y + 7, { align: "center" });
            // T√≠tulos de ejes para marco2
            pdf.setFontSize(5);
            pdf.text("Franjas Horarias", marco2.x + marco2.width / 2, marco2.y + marco2.height - 5, { align: "center" }); // Eje X
            pdf.text("Recuento de DELITO", marco2.x + 12, marco2.y + marco2.height / 2, { angle: 90, align: "center" });           // Eje Y (rotado)

            pdf.addImage(img1, "PNG", marco2.x + 5, marco2.y + 12, marco2.width - 10, marco2.height - 24);

            // Gr√°fico 3: Top 5 (anillo abajo centrado)
            const marco3 = { x: 150, y: 90 + margenSuperior, width: 120, height: 70 };
            pdf.roundedRect(marco3.x, marco3.y, marco3.width, marco3.height, 2, 2);
            pdf.setFontSize(7);
            pdf.text("Top 5 de delitos", marco3.x + marco3.width / 2, marco3.y + 9, { align: "center" });
            //pdf.addImage(img3, "PNG", marco3.x + 10, marco3.y + 12, marco3.width - 20, marco3.height - 15);

            // Escalar el canvas para exportarlo con m√°s resoluci√≥n
const scaleFactor = 2; // o 3 si quieres a√∫n m√°s nitidez
//const tmpCanvas = document.createElement("canvas");
tmpCanvas.width = canvasTop5.width * scaleFactor;
tmpCanvas.height = canvasTop5.height * scaleFactor;

const tmpCtx = tmpCanvas.getContext("2d");
tmpCtx.scale(scaleFactor, scaleFactor);
tmpCtx.drawImage(canvasTop5, 0, 0);

// Genera la imagen con alta definici√≥n
const img3 = tmpCanvas.toDataURL("image/png");
            pdf.addImage(img3, "PNG", marco3.x + 10, marco3.y -5, 100, 100);


            // Pie de p√°gina
            pdf.addImage(membretePieImg, "PNG", 250, 175 + margenSuperior, 30, 10);
            // === PIE DE P√ÅGINA ===
            pdf.setDrawColor(180, 180, 180); // l√≠nea gris clara
            pdf.setLineWidth(0.3);
            pdf.line(10, 185, 285, 185); // l√≠nea horizontal superior del pie

            pdf.setFontSize(8);
            pdf.setTextColor(100); // texto gris medio
            pdf.setFont(undefined, "italic");

            const footerY = 190; // posici√≥n vertical base
            const lineSpacing = 4;

            pdf.text("‚Ä¢ Se toma la base de datos de la Polic√≠a Nacional.", 15, footerY);
            pdf.text("‚Ä¢ La base de datos muestra los registros reportados por la ciudadan√≠a.", 15, footerY + lineSpacing);
            pdf.text("‚Ä¢ Se estima que solo el 60% de los delitos son reportados.", 15, footerY + 2 * lineSpacing);

            pdf.setTextColor(0); // vuelve a color negro por si se agrega m√°s texto despu√©s
            // Guardar PDF

    // üîπ Aqu√≠ insertamos el mapa FINAL (ya con clusters)
    pdf.addImage(imgMapFinal, "PNG", 10, 63 + margenSuperior, 125, 80);

    pdf.save("reporte_estadisticas.pdf");
});

    };
});



            </script>
        {% endif %}
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    $('#id_delito_dnpj').select2({
        placeholder: "Selecciona un delito",
        allowClear: true,
        width: '100%'
    });
});
function formatearMes(mesStr) {
    const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    const [anio, mes] = mesStr.split("-");
    const nombreMes = meses[parseInt(mes, 10) - 1];

    return `${nombreMes} ${anio}`;
}
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    const radioInput = document.getElementById("id_radio_km");
    const tipoSelect = document.getElementById("id_delito_dnpj");
    const exportarBtn = document.getElementById("btnExportarPDF");
    const graficarBtn = document.querySelector('button[name="accion"][value="graficar"]');
    const cargarBtn = document.querySelector('button[name="accion"][value="cargar"]');
    const mesBtn = document.getElementById("id_mes");

    // --- Saber si ya se carg√≥ el mapa (seg√∫n el backend Django) ---

    const mapaCargado = "{{ coordenadas|yesno:'true,false' }}" === "true";

    // --- Funci√≥n para activar/desactivar los controles ---
    function setEstadoControles(activo) {
        [radioInput, tipoSelect, exportarBtn, graficarBtn].forEach(el => el.disabled = !activo);
        [exportarBtn, graficarBtn].forEach(btn => {
            btn.style.opacity = activo ? "1" : "0.6";
            btn.style.cursor = activo ? "pointer" : "not-allowed";
        });
    }

    // --- Estado inicial ---
    if (mapaCargado) {
        setEstadoControles(true);
        mesBtn.disabled = true;
         cargarBtn.disabled = true;     // desactiva el bot√≥n de cargar
        cargarBtn.style.opacity = "0.6";
        cargarBtn.style.cursor = "not-allowed";

    } else {
        setEstadoControles(false);

    }

    // --- Al hacer clic en ‚ÄúCargar Mapa‚Äù se activan temporalmente (efecto visual inmediato) ---
    cargarBtn.addEventListener("click", function() {
        setEstadoControles(true);
    });
});
</script>



<script>
document.addEventListener("DOMContentLoaded", function () {
    const graficarBtn = document.querySelector('button[name="accion"][value="graficar"]');
    if (!graficarBtn) return;

    graficarBtn.addEventListener("click", function (e) {
        e.preventDefault(); // evita que recargue la p√°gina inmediatamente

        const lat = parseFloat(document.getElementById('lat_centro').value);
        const lon = parseFloat(document.getElementById('lon_centro').value);
        const radio = parseFloat(document.getElementById('radio_usado').value);

        if (isNaN(lat) || isNaN(lon) || isNaN(radio)) {
            alert("Por favor selecciona primero una ubicaci√≥n en el mapa o con el buscador.");
            return;
        }

        // Limpia el grupo anterior
        grupoFiltro.clearLayers();

        // Dibuja el marcador rojo y el c√≠rculo azul nuevamente
        L.marker([lat, lon], { icon: iconoRojo }).addTo(grupoFiltro);
        L.circle([lat, lon], { radius: radio, color: 'blue', fillOpacity: 0.1 }).addTo(grupoFiltro);

        // Centra el mapa
        map.setView([lat, lon], 14);

        // (Opcional) Si quieres que el formulario se env√≠e despu√©s de graficar:
        setTimeout(() => {
            e.target.form.submit();
        }, 300);
    });
});
</script>




</body>

</html>
